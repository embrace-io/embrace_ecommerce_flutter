name: iOS Simple Test

on:
  schedule:
    # Run every 2 hours at :15 (offset from other scheduled workflows)
    - cron: '15 */2 * * *'
  workflow_dispatch:

jobs:
  test-ios:
    name: iOS Quick Test
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.4"
          cache: true

      - name: Configure Embrace SDK
        run: |
          cat > ios/Runner/EmbraceConfig.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>AppId</key>
              <string>${{ vars.EMBRACE_APP_ID_IOS }}</string>
          </dict>
          </plist>
          EOF
          echo "Configured Embrace with App ID: ${{ vars.EMBRACE_APP_ID_IOS }}"

      - name: Get dependencies
        run: flutter pub get

      - name: Check available Xcode
        run: |
          ls /Applications | grep Xcode
          xcodebuild -version

      - name: List simulators
        run: xcrun simctl list devices available | grep -E "iPhone (14|15|16)" | head -10

      - name: Boot simulator
        id: sim
        run: |
          # Use iPhone 16 Pro (available on macos-15)
          UDID=$(xcrun simctl list devices available | grep "iPhone 16 Pro (" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "Using simulator UDID: $UDID"
          echo "udid=$UDID" >> $GITHUB_OUTPUT
          xcrun simctl boot "$UDID" || true
          sleep 10

      - name: Build and launch app
        run: |
          # Build for simulator
          flutter build ios --debug --simulator --no-codesign

          # Install on simulator
          xcrun simctl install ${{ steps.sim.outputs.udid }} build/ios/iphonesimulator/Runner.app

          # First launch - creates session
          echo "=== First app launch (creates session) ==="
          xcrun simctl launch ${{ steps.sim.outputs.udid }} io.embrace.embraceEcommerceFlutter
          echo "App launched, running for 20 seconds..."
          sleep 20

          # Terminate first session
          xcrun simctl terminate ${{ steps.sim.outputs.udid }} io.embrace.embraceEcommerceFlutter || true
          echo "First session ended, waiting..."
          sleep 5

          # Second launch - uploads previous session
          echo "=== Second app launch (uploads previous session) ==="
          xcrun simctl launch ${{ steps.sim.outputs.udid }} io.embrace.embraceEcommerceFlutter
          echo "App launched again, waiting 30 seconds for upload..."
          sleep 30

          # Terminate second session
          xcrun simctl terminate ${{ steps.sim.outputs.udid }} io.embrace.embraceEcommerceFlutter || true
          echo "Second session ended, waiting for final upload..."
          sleep 10

          # Third launch to upload second session
          echo "=== Third app launch (uploads second session) ==="
          xcrun simctl launch ${{ steps.sim.outputs.udid }} io.embrace.embraceEcommerceFlutter
          sleep 15
          xcrun simctl terminate ${{ steps.sim.outputs.udid }} io.embrace.embraceEcommerceFlutter || true
          sleep 5

      - name: Shutdown simulator
        if: always()
        run: xcrun simctl shutdown ${{ steps.sim.outputs.udid }} || true
